<html>

<head>
</head>

<body>
    <script type="text/javascript" src="https://formit3d.github.io/FormItExamplePlugins/SharedPluginFiles/FormItInterface.js"></script>
    <script type="text/javascript" src="https://formit3d.github.io/SharedPluginUtilities/FormIt_v22.js"></script>
    <script src="formit_with_lumion.js"></script>

    <script>
        FormItInterface.Initialize(async() => {
            window.LumionLiveSync = {};

            //remember state;
            let isStart = false;
            let isCameraOn = true;

            //Get the Camera Option from FormIt
            (async() => {
                const isCameraSyncOnStart = await FormIt.LumionLiveSync.GetOptions();
                await FormIt.LumionLiveSync.FollowLumionCamera(Boolean(isCameraSyncOnStart));
                //save to localstorage, this is how we'll share with main execution context.
                localStorage.setItem('LumionSettings', JSON.stringify({
                    cameraSync: isCameraSyncOnStart
                }));
            })();

            LumionLiveSync.Start = async() => {

                const settings = JSON.parse(localStorage.getItem('LumionSettings'));

                const cameraSync = settings.cameraSync || true;
                await FormIt.LumionLiveSync.FollowLumionCamera(Boolean(cameraSync));

                if (!isStart) {
                    await FormIt.LumionLiveSync.Start(Boolean(cameraSync));
                    await FormIt.PlugIn.SetIcon(window.location.origin, "Lumion toolbar", "StartButton", "Lumion/v22_0/images/pause.png");
                    await FormIt.PlugIn.SetIcon(window.location.origin, "Lumion toolbar", "StatusButton", "Lumion/v22_0/images/status_active.png");
                    await FormIt.PlugIn.SetIcon(window.location.origin, "Lumion toolbar", "StopButton", "Lumion/v22_0/images/stop.png");
                    await FormIt.PlugIn.SetIcon(window.location.origin, "Lumion toolbar", "CameraButton", "Lumion/v22_0/images/camera_stop.png");
                    await FormIt.PlugIn.SetIcon(window.location.origin, "Lumion toolbar", "SettingsButton", "Lumion/v22_0/images/settings.png");
                    await FormIt.PlugIn.SetIcon(window.location.origin, "Lumion toolbar", "ExportButton", "Lumion/v22_0/images/export.png");
                } else {
                    await FormIt.LumionLiveSync.Pause();
                    await FormIt.PlugIn.SetIcon(window.location.origin, "Lumion toolbar", "StartButton", "Lumion/v22_0/images/play.png");
                    await FormIt.PlugIn.SetIcon(window.location.origin, "Lumion toolbar", "StatusButton", "Lumion/v22_0/images/status_paused.png");
                    await FormIt.PlugIn.SetIcon(window.location.origin, "Lumion toolbar", "StopButton", "Lumion/v22_0/images/stop.png");
                    await FormIt.PlugIn.SetIcon(window.location.origin, "Lumion toolbar", "CameraButton", "Lumion/v22_0/images/camera_disabled.png");
                }
                isStart = !isStart;

            };

            LumionLiveSync.Reset = async() => {
                isStart = false;
                await FormIt.PlugIn.SetIcon(window.location.origin, "Lumion toolbar", "StartButton", "Lumion/v22_0/images/play.png");
                await FormIt.PlugIn.SetIcon(window.location.origin, "Lumion toolbar", "StatusButton", "Lumion/v22_0/images/status_inactive.png");
                await FormIt.PlugIn.SetIcon(window.location.origin, "Lumion toolbar", "StopButton", "Lumion/v22_0/images/stop_disabled.png");
                await FormIt.PlugIn.SetIcon(window.location.origin, "Lumion toolbar", "CameraButton", "Lumion/v22_0/images/camera_disabled.png");
                await FormIt.PlugIn.SetIcon(window.location.origin, "Lumion toolbar", "SettingsButton", "Lumion/v22_0/images/settings_disabled.png");
                await FormIt.PlugIn.SetIcon(window.location.origin, "Lumion toolbar", "ExportButton", "Lumion/v22_0/images/export_disabled.png");
            };

            LumionLiveSync.End = async() => {
                LumionLiveSync.Reset();
                await FormIt.LumionLiveSync.End();
             };

            LumionLiveSync.SyncLumionCameraOn = async() => {
                if (isStart) {
                    await FormIt.LumionLiveSync.SyncLumionCamera();

                    if (!isCameraOn) {
                        await FormIt.LumionLiveSync.FollowLumionCamera(true);
                        await FormIt.PlugIn.SetIcon(window.location.origin, "Lumion toolbar", "CameraButton", "Lumion/v22_0/images/camera_stop.png");
                    } else {
                        await FormIt.LumionLiveSync.FollowLumionCamera(false);
                        await FormIt.PlugIn.SetIcon(window.location.origin, "Lumion toolbar", "CameraButton", "Lumion/v22_0/images/camera_start.png");
                    }
                    isCameraOn = !isCameraOn;
                }
            };

            LumionLiveSync.Settings = async() => {
                if (isStart) {
                    const dialogParams = {
                        "PluginName": "Lumion Settings",
                        "DialogBox": `${window.location.origin}/Lumion/v22_0/settings.html`,
                        "DialogBoxWidth": 600,
                        "DialogBoxHeight": 215,
                        "DialogBoxType": "Modeless"
                    };

                    FormItInterface.CallMethod("FormIt.CreateDialogBox", JSON.stringify(dialogParams));

                    const storageUpdatedHandler = () => {
                        const hasProceededOnSettingsDialog = JSON.parse(localStorage.getItem('LumionSettings.hasProceededOnSettingsDialog'));

                        if (hasProceededOnSettingsDialog) {
                            removeEventListener('storage', storageUpdatedHandler, true);

                            // Set the Camera option in FormIt
                            const settings = JSON.parse(localStorage.getItem('LumionSettings'));
                            const cameraSync = settings.cameraSync;
                            //await not necessary here, yet.
                            FormIt.LumionLiveSync.SetOptions(Boolean(cameraSync));
                        }
                    };

                    localStorage.setItem('LumionSettings.hasProceededOnSettingsDialog', false);
                    const storageEventListener = addEventListener('storage', storageUpdatedHandler, true);
                }
            };

            LumionLiveSync.Help = async() => {
                const dialogParams = {
                    "PluginName": "Lumion Help",
                    "DialogBox": `${window.location.origin}/Lumion/v22_0/Help.html`,
                    "DialogBoxWidth": 730,
                    "DialogBoxHeight": 500,
                    "DialogBoxType": "Modeless"
                };

                FormItInterface.CallMethod("FormIt.CreateDialogBox", JSON.stringify(dialogParams));
            };


            LumionLiveSync.Export = async() => {
                if (isStart) {
                    await FormIt.Commands.DoCommand("File: Export Locally...");
                }
            };

            LumionLiveSync.TODO = async() => {
                //TODO needs implemented
            };

            LumionLiveSync.NOOP = () => {};
            
            // Call End on new model request.
            FormItInterface.SubscribeMessage("FormIt.Message.kNewModelRequested", (msg) => {
                LumionLiveSync.End();
            });

            // Check to see if Lumion is closing the document.
            FormItInterface.SubscribeMessage("FormIt.Message.kTimerTicked", (msg) => {
                if (isStart)
                {
                    const isClosing = await FormIt.LumionLiveSync.isClosing();
                    if (isClosing)
                    {
                        LumionLiveSync.End();
                    }
                }
            });

        });
    </script>
</body>

</html>